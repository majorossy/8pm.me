<?php
/**
 * ArchiveDotOrg Core Module - Audio Player Template
 *
 * Features:
 * - Responsive mobile-first design
 * - Dark mode support
 * - ARIA accessibility
 * - Keyboard shortcuts guide
 *
 * @var \ArchiveDotOrg\Core\Block\Player $block
 */

if (!$block->hasPlayableItems()) {
    return;
}

$playlistJson = $block->getPlaylistJson();
$itemCount = $block->getPlayableItemCount();
$playerId = 'archivedotorg-player-' . uniqid();
?>

<div class="archivedotorg-player" id="<?= $block->escapeHtmlAttr($playerId) ?>" role="application" aria-label="<?= $block->escapeHtml(__('Audio Player')) ?>">
    <div class="player-header">
        <h3 id="<?= $block->escapeHtmlAttr($playerId) ?>-title"><?= $block->escapeHtml(__('Audio Player')) ?></h3>
        <span class="track-count" aria-live="polite"><?= $block->escapeHtml(__('%1 tracks', $itemCount)) ?></span>
    </div>

    <div class="jp-now-playing" aria-live="polite" aria-atomic="true">
        <span class="jp-now-playing-label"><?= $block->escapeHtml(__('Now Playing:')) ?></span>
        <span class="jp-current-track"><?= $block->escapeHtml(__('No track selected')) ?></span>
    </div>

    <div class="jp-gui jp-interface">
        <!-- Primary Controls -->
        <div class="jp-controls" role="group" aria-label="<?= $block->escapeHtml(__('Playback controls')) ?>">
            <button class="jp-previous" type="button" aria-label="<?= $block->escapeHtml(__('Previous track')) ?>" title="<?= $block->escapeHtml(__('Previous (Shift+Left or P)')) ?>">
                <span class="jp-icon" aria-hidden="true">&#9664;&#9664;</span>
                <span class="jp-label"><?= $block->escapeHtml(__('Prev')) ?></span>
            </button>
            <button class="jp-play" type="button" aria-label="<?= $block->escapeHtml(__('Play')) ?>" aria-pressed="false" title="<?= $block->escapeHtml(__('Play/Pause (Space or K)')) ?>">
                <span class="jp-icon jp-icon-play" aria-hidden="true">&#9654;</span>
                <span class="jp-icon jp-icon-pause" aria-hidden="true">&#10074;&#10074;</span>
                <span class="jp-label"><?= $block->escapeHtml(__('Play')) ?></span>
            </button>
            <button class="jp-stop" type="button" aria-label="<?= $block->escapeHtml(__('Stop')) ?>" title="<?= $block->escapeHtml(__('Stop')) ?>">
                <span class="jp-icon" aria-hidden="true">&#9632;</span>
                <span class="jp-label"><?= $block->escapeHtml(__('Stop')) ?></span>
            </button>
            <button class="jp-next" type="button" aria-label="<?= $block->escapeHtml(__('Next track')) ?>" title="<?= $block->escapeHtml(__('Next (Shift+Right or N)')) ?>">
                <span class="jp-icon" aria-hidden="true">&#9654;&#9654;</span>
                <span class="jp-label"><?= $block->escapeHtml(__('Next')) ?></span>
            </button>
        </div>

        <!-- Progress Bar -->
        <div class="jp-progress-container">
            <div class="jp-time-holder">
                <span class="jp-current-time" role="timer" aria-label="<?= $block->escapeHtml(__('Current time')) ?>">0:00</span>
            </div>
            <div class="jp-progress">
                <div class="jp-seek-bar" role="slider" aria-label="<?= $block->escapeHtml(__('Seek')) ?>" aria-valuemin="0" aria-valuenow="0" aria-valuemax="100" tabindex="0">
                    <div class="jp-play-bar"></div>
                </div>
            </div>
            <div class="jp-time-holder">
                <span class="jp-duration" role="timer" aria-label="<?= $block->escapeHtml(__('Duration')) ?>">0:00</span>
            </div>
        </div>

        <!-- Secondary Controls -->
        <div class="jp-secondary-controls">
            <!-- Volume Controls -->
            <div class="jp-volume-controls" role="group" aria-label="<?= $block->escapeHtml(__('Volume controls')) ?>">
                <button class="jp-mute" type="button" aria-label="<?= $block->escapeHtml(__('Mute')) ?>" aria-pressed="false" title="<?= $block->escapeHtml(__('Mute (M)')) ?>">
                    <span class="jp-icon jp-icon-volume" aria-hidden="true">&#128266;</span>
                    <span class="jp-icon jp-icon-muted" aria-hidden="true">&#128263;</span>
                </button>
                <div class="jp-volume-bar" role="slider" aria-label="<?= $block->escapeHtml(__('Volume')) ?>" aria-valuemin="0" aria-valuenow="100" aria-valuemax="100" tabindex="0" title="<?= $block->escapeHtml(__('Volume (Up/Down arrows)')) ?>">
                    <div class="jp-volume-bar-value"></div>
                </div>
            </div>

            <!-- Toggle Controls -->
            <div class="jp-toggles" role="group" aria-label="<?= $block->escapeHtml(__('Playback options')) ?>">
                <button class="jp-shuffle" type="button" aria-label="<?= $block->escapeHtml(__('Shuffle')) ?>" aria-pressed="false" title="<?= $block->escapeHtml(__('Shuffle (S)')) ?>">
                    <span class="jp-icon" aria-hidden="true">&#128256;</span>
                    <span class="jp-label"><?= $block->escapeHtml(__('Shuffle')) ?></span>
                </button>
                <button class="jp-repeat jp-state-repeat-none" type="button" aria-label="<?= $block->escapeHtml(__('Repeat: none')) ?>" title="<?= $block->escapeHtml(__('Repeat (R)')) ?>">
                    <span class="jp-icon" aria-hidden="true">&#128257;</span>
                    <span class="jp-label"><?= $block->escapeHtml(__('Repeat')) ?></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Playlist -->
    <div class="jp-playlist" role="listbox" aria-label="<?= $block->escapeHtml(__('Playlist')) ?>">
        <ul role="presentation">
            <li></li>
        </ul>
    </div>

    <!-- Keyboard Shortcuts Help -->
    <details class="jp-keyboard-help">
        <summary><?= $block->escapeHtml(__('Keyboard Shortcuts')) ?></summary>
        <dl>
            <dt><kbd>Space</kbd> / <kbd>K</kbd></dt>
            <dd><?= $block->escapeHtml(__('Play/Pause')) ?></dd>
            <dt><kbd>&larr;</kbd> / <kbd>&rarr;</kbd></dt>
            <dd><?= $block->escapeHtml(__('Seek 10 seconds')) ?></dd>
            <dt><kbd>Shift</kbd>+<kbd>&larr;</kbd> / <kbd>&rarr;</kbd></dt>
            <dd><?= $block->escapeHtml(__('Previous/Next track')) ?></dd>
            <dt><kbd>&uarr;</kbd> / <kbd>&darr;</kbd></dt>
            <dd><?= $block->escapeHtml(__('Volume up/down')) ?></dd>
            <dt><kbd>M</kbd></dt>
            <dd><?= $block->escapeHtml(__('Mute')) ?></dd>
            <dt><kbd>S</kbd></dt>
            <dd><?= $block->escapeHtml(__('Toggle shuffle')) ?></dd>
            <dt><kbd>R</kbd></dt>
            <dd><?= $block->escapeHtml(__('Cycle repeat mode')) ?></dd>
            <dt><kbd>0</kbd>-<kbd>9</kbd></dt>
            <dd><?= $block->escapeHtml(__('Jump to 0-90% of track')) ?></dd>
        </dl>
    </details>

    <!-- No Solution Message -->
    <div class="jp-no-solution" hidden>
        <span><?= $block->escapeHtml(__('Update Required')) ?></span>
        <?= $block->escapeHtml(__('To play the media you will need to update your browser to a recent version.')) ?>
    </div>
</div>

<script type="text/x-magento-init">
{
    "#<?= $block->escapeJs($playerId) ?>": {
        "ArchiveDotOrg_Core/js/player": {
            "playlist": <?= /* @noEscape */ $playlistJson ?>,
            "playerId": "<?= $block->escapeJs($playerId) ?>"
        }
    }
}
</script>

<style>
    /* Base Styles - Mobile First */
    .archivedotorg-player {
        margin-bottom: 20px;
        padding: 16px;
        background: var(--player-bg, #f5f5f5);
        border-radius: 8px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        color: var(--player-text, #333);
    }

    /* Dark Mode Support */
    @media (prefers-color-scheme: dark) {
        .archivedotorg-player {
            --player-bg: #1a1a1a;
            --player-text: #e0e0e0;
            --player-border: #333;
            --player-progress-bg: #333;
            --player-progress-fill: #1979c3;
            --player-button-bg: #2a2a2a;
            --player-button-hover: #3a3a3a;
            --player-button-active: #1979c3;
            --player-playlist-hover: #2a2a2a;
            --player-playlist-current: #1979c3;
        }
    }

    /* Light mode defaults */
    .archivedotorg-player {
        --player-bg: #f5f5f5;
        --player-text: #333;
        --player-border: #ddd;
        --player-progress-bg: #ddd;
        --player-progress-fill: #1979c3;
        --player-button-bg: #fff;
        --player-button-hover: #e8e8e8;
        --player-button-active: #1979c3;
        --player-playlist-hover: #e8e8e8;
        --player-playlist-current: #1979c3;
    }

    /* Header */
    .archivedotorg-player .player-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        flex-wrap: wrap;
        gap: 8px;
    }

    .archivedotorg-player .player-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
    }

    .archivedotorg-player .track-count {
        color: var(--player-text);
        opacity: 0.7;
        font-size: 14px;
    }

    /* Now Playing */
    .archivedotorg-player .jp-now-playing {
        margin-bottom: 12px;
        padding: 8px 12px;
        background: var(--player-button-bg);
        border-radius: 6px;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .archivedotorg-player .jp-now-playing-label {
        opacity: 0.7;
        margin-right: 8px;
    }

    .archivedotorg-player .jp-current-track {
        font-weight: 500;
    }

    /* Controls */
    .archivedotorg-player .jp-controls {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-bottom: 12px;
    }

    .archivedotorg-player button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 16px;
        border: 1px solid var(--player-border);
        background: var(--player-button-bg);
        color: var(--player-text);
        cursor: pointer;
        border-radius: 6px;
        font-size: 14px;
        transition: background 0.15s ease, transform 0.1s ease;
        min-width: 44px;
        min-height: 44px;
    }

    .archivedotorg-player button:hover {
        background: var(--player-button-hover);
    }

    .archivedotorg-player button:active {
        transform: scale(0.95);
    }

    .archivedotorg-player button:focus-visible {
        outline: 2px solid var(--player-progress-fill);
        outline-offset: 2px;
    }

    .archivedotorg-player button[aria-pressed="true"] {
        background: var(--player-button-active);
        color: #fff;
        border-color: var(--player-button-active);
    }

    .archivedotorg-player .jp-icon {
        font-size: 16px;
        line-height: 1;
    }

    .archivedotorg-player .jp-label {
        margin-left: 6px;
    }

    /* Hide icon variants based on state */
    .archivedotorg-player .jp-play .jp-icon-pause,
    .archivedotorg-player .jp-mute .jp-icon-muted {
        display: none;
    }

    .archivedotorg-player .jp-play[aria-pressed="true"] .jp-icon-play,
    .archivedotorg-player .jp-mute[aria-pressed="true"] .jp-icon-volume {
        display: none;
    }

    .archivedotorg-player .jp-play[aria-pressed="true"] .jp-icon-pause,
    .archivedotorg-player .jp-mute[aria-pressed="true"] .jp-icon-muted {
        display: inline;
    }

    /* Progress Container */
    .archivedotorg-player .jp-progress-container {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }

    .archivedotorg-player .jp-progress {
        flex: 1;
        height: 8px;
        background: var(--player-progress-bg);
        border-radius: 4px;
        cursor: pointer;
        position: relative;
    }

    .archivedotorg-player .jp-seek-bar {
        width: 100%;
        height: 100%;
        border-radius: 4px;
    }

    .archivedotorg-player .jp-play-bar {
        height: 100%;
        background: var(--player-progress-fill);
        border-radius: 4px;
        width: 0;
        transition: width 0.1s linear;
    }

    .archivedotorg-player .jp-time-holder {
        font-size: 12px;
        font-variant-numeric: tabular-nums;
        min-width: 40px;
        text-align: center;
    }

    /* Secondary Controls */
    .archivedotorg-player .jp-secondary-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 12px;
    }

    /* Volume Controls */
    .archivedotorg-player .jp-volume-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .archivedotorg-player .jp-volume-bar {
        width: 80px;
        height: 6px;
        background: var(--player-progress-bg);
        border-radius: 3px;
        cursor: pointer;
        position: relative;
    }

    .archivedotorg-player .jp-volume-bar-value {
        height: 100%;
        background: var(--player-progress-fill);
        border-radius: 3px;
        width: 100%;
    }

    /* Toggles */
    .archivedotorg-player .jp-toggles {
        display: flex;
        gap: 8px;
    }

    .archivedotorg-player .jp-toggles button {
        padding: 8px 12px;
    }

    /* Repeat State Indicators */
    .archivedotorg-player .jp-repeat.jp-state-repeat-all .jp-label::after {
        content: ' All';
    }

    .archivedotorg-player .jp-repeat.jp-state-repeat-one .jp-label::after {
        content: ' 1';
    }

    /* Playlist */
    .archivedotorg-player .jp-playlist ul {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid var(--player-border);
        border-radius: 6px;
    }

    .archivedotorg-player .jp-playlist li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        border-bottom: 1px solid var(--player-border);
        cursor: pointer;
        transition: background 0.15s ease;
    }

    .archivedotorg-player .jp-playlist li:last-child {
        border-bottom: none;
    }

    .archivedotorg-player .jp-playlist li:hover {
        background: var(--player-playlist-hover);
    }

    .archivedotorg-player .jp-playlist li:focus {
        outline: 2px solid var(--player-progress-fill);
        outline-offset: -2px;
    }

    .archivedotorg-player .jp-playlist li.jp-playlist-current {
        background: var(--player-playlist-current);
        color: #fff;
    }

    .archivedotorg-player .jp-playlist-item-title {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-right: 12px;
    }

    .archivedotorg-player .jp-playlist-item-duration {
        font-size: 12px;
        opacity: 0.7;
        font-variant-numeric: tabular-nums;
    }

    /* Keyboard Help */
    .archivedotorg-player .jp-keyboard-help {
        margin-top: 12px;
        font-size: 12px;
    }

    .archivedotorg-player .jp-keyboard-help summary {
        cursor: pointer;
        opacity: 0.7;
        padding: 8px 0;
    }

    .archivedotorg-player .jp-keyboard-help summary:hover {
        opacity: 1;
    }

    .archivedotorg-player .jp-keyboard-help dl {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 4px 16px;
        margin: 8px 0;
        padding: 12px;
        background: var(--player-button-bg);
        border-radius: 6px;
    }

    .archivedotorg-player .jp-keyboard-help dt {
        font-weight: normal;
    }

    .archivedotorg-player .jp-keyboard-help kbd {
        display: inline-block;
        padding: 2px 6px;
        background: var(--player-progress-bg);
        border-radius: 3px;
        font-family: inherit;
        font-size: 11px;
    }

    .archivedotorg-player .jp-keyboard-help dd {
        margin: 0;
        opacity: 0.8;
    }

    /* No Solution */
    .archivedotorg-player .jp-no-solution {
        padding: 20px;
        text-align: center;
        color: #c00;
    }

    /* Mobile Responsive */
    @media (max-width: 480px) {
        .archivedotorg-player {
            padding: 12px;
        }

        .archivedotorg-player .jp-controls {
            flex-wrap: wrap;
        }

        .archivedotorg-player .jp-label {
            display: none;
        }

        .archivedotorg-player button {
            padding: 12px;
        }

        .archivedotorg-player .jp-secondary-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .archivedotorg-player .jp-volume-controls {
            justify-content: center;
        }

        .archivedotorg-player .jp-volume-bar {
            flex: 1;
            max-width: 150px;
        }

        .archivedotorg-player .jp-toggles {
            justify-content: center;
        }

        .archivedotorg-player .jp-playlist ul {
            max-height: 180px;
        }

        .archivedotorg-player .jp-keyboard-help {
            display: none;
        }
    }

    /* Tablet */
    @media (min-width: 481px) and (max-width: 768px) {
        .archivedotorg-player .jp-toggles button .jp-label {
            display: none;
        }
    }

    /* High Contrast Mode Support */
    @media (prefers-contrast: high) {
        .archivedotorg-player button {
            border-width: 2px;
        }

        .archivedotorg-player .jp-playlist li:focus {
            outline-width: 3px;
        }
    }

    /* Reduced Motion Support */
    @media (prefers-reduced-motion: reduce) {
        .archivedotorg-player button,
        .archivedotorg-player .jp-play-bar,
        .archivedotorg-player .jp-playlist li {
            transition: none;
        }
    }
</style>
