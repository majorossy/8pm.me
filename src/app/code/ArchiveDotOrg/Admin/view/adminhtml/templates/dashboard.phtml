<?php
/**
 * @var \ArchiveDotOrg\Admin\Block\Adminhtml\Dashboard $block
 */
?>

<div class="archivedotorg-dashboard">
    <h1><?= __('Archive.org Import Dashboard') ?></h1>
    
    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="stat-value"><?= $block->getTotalArtists() ?></div>
            <div class="stat-label"><?= __('Artists') ?></div>
        </div>
        
        <div class="stat-card">
            <div class="stat-value"><?= number_format($block->getTotalShows()) ?></div>
            <div class="stat-label"><?= __('Shows Downloaded') ?></div>
        </div>
        
        <div class="stat-card">
            <div class="stat-value"><?= number_format($block->getTotalTracks()) ?></div>
            <div class="stat-label"><?= __('Tracks Imported') ?></div>
        </div>
        
        <div class="stat-card">
            <div class="stat-value"><?= $block->getOverallMatchRate() ?>%</div>
            <div class="stat-label"><?= __('Match Rate') ?></div>
        </div>
        
        <div class="stat-card">
            <div class="stat-value <?= $block->getActiveImports() > 0 ? 'active' : '' ?>">
                <?= $block->getActiveImports() ?>
            </div>
            <div class="stat-label"><?= __('Active Imports') ?></div>
        </div>
    </div>
    
    <div class="dashboard-actions">
        <a href="<?= $block->getUrl('archivedotorg/artist/index') ?>" class="action-default scalable">
            <span><?= __('View Artists') ?></span>
        </a>
        <a href="<?= $block->getUrl('archivedotorg/history/index') ?>" class="action-default scalable">
            <span><?= __('Import History') ?></span>
        </a>
        <a href="<?= $block->getUrl('archivedotorg/unmatched/index') ?>" class="action-default scalable">
            <span><?= __('Unmatched Tracks') ?></span>
        </a>
    </div>
    
    <div id="active-imports-container" style="display: none;">
        <h2><?= __('Active Import Progress') ?></h2>
        <div id="progress-widgets"></div>
    </div>
</div>

<style>
.archivedotorg-dashboard {
    padding: 20px;
}

.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 30px 0;
}

.stat-card {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 20px;
    text-align: center;
}

.stat-value {
    font-size: 36px;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
}

.stat-value.active {
    color: #ff5501;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

.stat-label {
    font-size: 14px;
    color: #666;
    text-transform: uppercase;
}

.dashboard-actions {
    margin: 30px 0;
    display: flex;
    gap: 10px;
}

.dashboard-actions .action-default {
    display: inline-block;
    padding: 10px 20px;
    background: #eb5202;
    color: #fff;
    text-decoration: none;
    border-radius: 3px;
    transition: background 0.2s;
}

.dashboard-actions .action-default:hover {
    background: #c44601;
}

#active-imports-container {
    margin-top: 30px;
    padding: 20px;
    background: #f5f5f5;
    border-radius: 4px;
}

#progress-widgets .progress-widget {
    background: #fff;
    padding: 15px;
    margin: 10px 0;
    border-radius: 4px;
    border: 1px solid #ddd;
}

#progress-widgets .progress-bar {
    height: 20px;
    background: #eee;
    border-radius: 3px;
    overflow: hidden;
    margin: 10px 0;
}

#progress-widgets .progress-bar-fill {
    height: 100%;
    background: #eb5202;
    transition: width 0.3s;
}
</style>

<script>
require(['jquery'], function($) {
    'use strict';
    
    var progressUrl = '<?= $block->escapeJs($block->getProgressUrl()) ?>';
    var pollingInterval = null;
    var activeImports = {};
    
    function checkForActiveImports() {
        // In a real implementation, we'd poll for all active artists
        // For now, just check if the active imports count > 0
        var activeCount = parseInt($('.stat-card .stat-value.active').text());
        
        if (activeCount > 0) {
            $('#active-imports-container').show();
        } else {
            $('#active-imports-container').hide();
        }
    }
    
    function updateProgress(artist) {
        $.ajax({
            url: progressUrl,
            data: { artist: artist },
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                if (data.status === 'running') {
                    renderProgressWidget(data);
                } else if (data.status === 'completed' || data.status === 'failed') {
                    removeProgressWidget(artist);
                }
            }
        });
    }
    
    function renderProgressWidget(data) {
        var widgetId = 'progress-' + data.artist.replace(/[^a-z0-9]/gi, '-').toLowerCase();
        var widget = $('#' + widgetId);
        
        if (widget.length === 0) {
            widget = $('<div/>')
                .attr('id', widgetId)
                .addClass('progress-widget')
                .appendTo('#progress-widgets');
        }
        
        var percent = data.total > 0 ? Math.round((data.current / data.total) * 100) : 0;
        var eta = data.eta ? new Date(data.eta).toLocaleTimeString() : 'Calculating...';
        
        widget.html(
            '<h3>' + data.artist + '</h3>' +
            '<div class="progress-info">' +
            '<span>' + data.current + ' / ' + data.total + ' (' + percent + '%)</span>' +
            '<span style="float: right;">ETA: ' + eta + '</span>' +
            '</div>' +
            '<div class="progress-bar">' +
            '<div class="progress-bar-fill" style="width: ' + percent + '%"></div>' +
            '</div>' +
            '<small>Correlation ID: ' + data.correlation_id + '</small>'
        );
        
        activeImports[data.artist] = true;
    }
    
    function removeProgressWidget(artist) {
        var widgetId = 'progress-' + artist.replace(/[^a-z0-9]/gi, '-').toLowerCase();
        $('#' + widgetId).fadeOut(300, function() {
            $(this).remove();
            delete activeImports[artist];
            
            if (Object.keys(activeImports).length === 0) {
                $('#active-imports-container').hide();
            }
        });
    }
    
    // Check on page load
    checkForActiveImports();
    
    // TODO: In production, get list of active artists from server
    // and poll their progress. For now, this is just the structure.
});
</script>
